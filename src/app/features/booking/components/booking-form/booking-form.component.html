<div class="card p-4">
  <h2 class="text-900 mb-4">Dynamic Flight Booking</h2>

  <form [formGroup]="bookingForm">
    <div formArrayName="flights">
      <div *ngFor="let flight of flights.controls; let i = index" [formGroupName]="i" class="mb-5">
        
        <p-card [header]="'Flight #' + (i + 1)" styleClass="shadow-2 border-1 border-50">
          <div class="grid p-fluid">
            <div class="col-12 md:col-4">
              <label class="block font-bold mb-2">From</label>
              <p-dropdown [options]="cities" formControlName="fromCity" placeholder="Select Origin"></p-dropdown>
            </div>

            <div class="col-12 md:col-4">
              <label class="block font-bold mb-2">To</label>
              <p-dropdown [options]="cities" formControlName="toCity" placeholder="Select Destination"></p-dropdown>
            </div>

            <div class="col-12 md:col-4">
              <label class="block font-bold mb-2">Departure Date</label>
              <p-calendar formControlName="departureDate" [showIcon]="true"></p-calendar>
            </div>
          </div>

          <hr class="my-4 border-top-1 border-200" />

          <div formArrayName="passengers">
            <h4 class="text-700 mb-3"><i class="pi pi-users mr-2"></i>Passengers</h4>
            
            <div *ngFor="let passenger of getPassengers(i).controls; let j = index" [formGroupName]="j" 
                 class="grid p-fluid align-items-center mb-3 p-3 border-round surface-50">
              
              <div class="col-12 md:col-3">
                <input pInputText formControlName="name" placeholder="Full Name" />
              </div>

              <div class="col-12 md:col-2">
                <p-inputNumber formControlName="age" placeholder="Age" [min]="0" [max]="100"></p-inputNumber>
              </div>

              <div class="col-12 md:col-3">
                <p-dropdown [options]="genders" formControlName="gender" placeholder="Gender"></p-dropdown>
              </div>

              <div class="col-12 md:col-2">
                <div class="p-inputgroup">
                  <span class="p-inputgroup-addon">$</span>
                  <p-inputNumber formControlName="discountedFare" [disabled]="true" placeholder="Fare"></p-inputNumber>
                </div>
              </div>

              <div class="col-12 md:col-2 text-right">
                <button pButton icon="pi pi-trash" class="p-button-danger p-button-text" 
                        (click)="removePassenger(i, j)" *ngIf="getPassengers(i).length > 1"></button>
              </div>
            </div>

            <button pButton label="Add Passenger" icon="pi pi-plus" 
                    class="p-button-outlined p-button-sm mt-2" (click)="addPassenger(i)"></button>
          </div>

          <ng-template pTemplate="footer">
            <div class="flex justify-content-end">
              <button pButton label="Remove Flight" icon="pi pi-times" 
                      class="p-button-text p-button-danger" (click)="removeFlight(i)" 
                      *ngIf="flights.length > 1"></button>
            </div>
          </ng-template>
        </p-card>

      </div>
    </div>

    <div class="flex justify-content-between mt-4">
      <button pButton label="Add Another Flight" icon="pi pi-plus" 
              class="p-button-secondary" (click)="addFlight()"></button>
     
    </div>
  </form>


 <div class="fixed bottom-0 left-0 w-full bg-white shadow-8 p-4 border-top-1 border-200 z-5">
  <div class="container flex justify-content-between align-items-center" style="max-width: 1200px; margin: 0 auto;">
    <div>
      <span class="block text-600 font-medium text-sm">GRAND TOTAL</span>
      <span class="text-3xl font-bold text-900">{{ (totalCost$ | async) || 0 | currency }}</span>
    </div>
    
    <div class="flex gap-3">
      <button pButton 
              label="Complete Booking" 
              icon="pi pi-check" 
              class="p-button-success p-button-lg px-6" 
              [disabled]="bookingForm.invalid"
              (click)="onSubmit()">
      </button>
    </div>
  </div>
</div>

<p-dialog header="Confirm Your Booking" [(visible)]="displaySummary" [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    
    <div *ngIf="summaryData as data">
        <div class="surface-50 p-3 border-round mb-4">
            <div class="flex justify-content-between mb-2">
                <span class="text-700">Total Flights:</span>
                <span class="font-bold">{{ data.totalFlights }}</span>
            </div>
            <div class="flex justify-content-between">
                <span class="text-700">Total Passengers:</span>
                <span class="font-bold">{{ data.totalPassengers }}</span>
            </div>
        </div>

        <h4 class="mb-3">Itinerary Details</h4>
        <div *ngFor="let f of data.flights; let last = last" class="mb-3">
            <div class="flex align-items-center gap-3">
                <i class="pi pi-send text-primary"></i>
                <span class="font-medium">{{ f.fromCity }} âž” {{ f.toCity }}</span>
                <span class="text-600 ml-auto">{{ f.departureDate | date:'mediumDate' }}</span>
            </div>
            <p-divider *ngIf="!last"></p-divider>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton icon="pi pi-times" (click)="displaySummary=false" label="Cancel" class="p-button-text"></button>
        <button pButton icon="pi pi-check" (click)="confirmFinalBooking()" label="Confirm & Pay" class="p-button-success" [loading]="isSubmitting"></button>
    </ng-template>
</p-dialog>
</div>
<p-toast></p-toast>